#!/usr/bin/env python3
"""
DÃ©chiffreur simple pour task.py
"""

import re
import zlib
import marshal
import sys

# Lire le fichier
with open('task.py', 'r', encoding='utf-8', errors='ignore') as f:
    content = f.read()

# Chercher la payload hex
hex_match = re.search(r"'([a-f0-9]{500,})'", content)
if hex_match:
    print("âœ… Payload hex trouvÃ©e")
    hex_data = hex_match.group(1)
    
    try:
        # Convertir hex -> bytes
        encrypted_bytes = bytes.fromhex(hex_data)
        print(f"ðŸ“¦ Taille payload: {len(encrypted_bytes)} bytes")
        
        # DÃ©compresser avec zlib
        decompressed = zlib.decompress(encrypted_bytes)
        print(f"ðŸ“¦ Taille dÃ©compressÃ©e: {len(decompressed)} bytes")
        
        # Charger l'objet marshal
        code_obj = marshal.loads(decompressed)
        print(f"âœ… Objet code chargÃ©")
        
        # Essayer de dÃ©compiler
        try:
            import uncompyle6
            print("ðŸ”§ DÃ©compilation avec uncompyle6...")
            
            # DÃ©compiler en mÃ©moire
            import io
            output = io.StringIO()
            uncompyle6.deparse_code2str(code_obj, output)
            source_code = output.getvalue()
            
            # Sauvegarder
            with open('task_decrypted_real.py', 'w', encoding='utf-8') as f:
                # Ã‰crire les variables originales
                f.write("# Variables originales:\n")
                for line in content.split('\n'):
                    if '=' in line and len(line) < 100:
                        f.write(line + '\n')
                
                f.write("\n" + "="*60 + "\n")
                f.write("# CODE DÃ‰CHIFFRÃ‰:\n")
                f.write("="*60 + "\n\n")
                f.write(source_code)
            
            print("âœ… Fichier sauvegardÃ©: task_decrypted_real.py")
            print(f"ðŸ“„ Taille: {len(source_code)} caractÃ¨res")
            
            # Afficher un aperÃ§u
            print("\nðŸ“‹ AperÃ§u du code dÃ©chiffrÃ©:")
            print("-" * 40)
            lines = source_code.split('\n')
            for i in range(min(30, len(lines))):
                print(lines[i])
            
            if len(lines) > 30:
                print("...")
            
        except ImportError:
            print("âš ï¸ uncompyle6 non installÃ©. Installation:")
            print("pip install uncompyle6")
            
            # Sauvegarder le bytecode
            import dis
            with open('task_bytecode.txt', 'w') as f:
                dis.dis(code_obj, file=f)
            print("âœ… Bytecode sauvegardÃ©: task_bytecode.txt")
            
            # Sauvegarder l'objet marshal
            with open('task_codeobj.bin', 'wb') as f:
                marshal.dump(code_obj, f)
            print("âœ… Objet code sauvegardÃ©: task_codeobj.bin")
        
        # ExÃ©cuter le code dÃ©chiffrÃ©
        print("\nðŸŽ® ExÃ©cuter le code dÃ©chiffrÃ©? (o/n)")
        if input().strip().lower() == 'o':
            print("\nðŸš€ EXÃ‰CUTION...")
            print("=" * 40)
            exec(code_obj)
        
    except Exception as e:
        print(f"âŒ Erreur: {e}")
        import traceback
        traceback.print_exc()

else:
    print("âŒ Aucune payload hex trouvÃ©e")
    
    # Chercher autre chose
    print("\nðŸ” Recherche d'autres patterns...")
    
    # Chercher marshal loads
    if "marshal" in content and "loads" in content:
        print("âœ… marshal.loads dÃ©tectÃ©")
        
        # Extraire les variables
        print("\nðŸ“Š Variables dÃ©tectÃ©es:")
        lines = content.split('\n')
        for line in lines:
            if '=' in line and not line.strip().startswith('#'):
                if len(line) > 150:
                    print(f"[LONG] {line[:80]}...")
                else:
                    print(line)
