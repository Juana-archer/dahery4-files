#!/usr/bin/env python3
# run_decrypted.py - Ex√©cute le code d√©chiffr√© avec gestion d'imports

import marshal
import sys
import subprocess

def install_missing_packages():
    """Installe les packages manquants automatiquement"""
    
    packages = ['colorama', 'requests', 'telethon', 'asyncio']
    
    print("üîß Installation des d√©pendances...")
    
    for package in packages:
        try:
            __import__(package)
            print(f"‚úÖ {package} d√©j√† install√©")
        except ImportError:
            print(f"üì¶ Installation de {package}...")
            try:
                subprocess.check_call([sys.executable, "-m", "pip", "install", package])
                print(f"‚úÖ {package} install√©")
            except Exception as e:
                print(f"‚ö†Ô∏è  √âchec installation {package}: {e}")

def patch_code_execution():
    """Ex√©cute le code avec patch pour les imports"""
    
    print("\nüîì CHARGEMENT DU CODE D√âCHIFFR√â")
    print("=" * 50)
    
    # 1. Charger l'objet code
    try:
        with open('code_object.bin', 'rb') as f:
            code_obj = marshal.load(f)
        print("‚úÖ Code objet charg√©")
    except FileNotFoundError:
        print("‚ùå code_object.bin non trouv√©")
        print("   Ex√©cutez d'abord: python real_decrypt.py")
        return None
    
    # 2. Cr√©er un environnement d'ex√©cution avec imports simul√©s
    import builtins
    
    # Sauvegarder l'exec original
    original_exec = builtins.exec
    
    def patched_exec(code, globals=None, locals=None):
        """Patch exec pour g√©rer NameError"""
        if globals is None:
            globals = {}
        
        # Ajouter des imports courants
        try:
            import colorama
            from colorama import Fore, Style, Back, init as colorama_init
            globals['Fore'] = Fore
            globals['Style'] = Style
            globals['Back'] = Back
            globals['colorama_init'] = colorama_init
            colorama_init(autoreset=True)
        except ImportError:
            pass
        
        try:
            import requests
            globals['requests'] = requests
        except ImportError:
            pass
        
        try:
            import asyncio
            globals['asyncio'] = asyncio
        except ImportError:
            pass
        
        # Ex√©cuter avec gestion d'erreurs
        try:
            return original_exec(code, globals, locals)
        except NameError as e:
            error_msg = str(e)
            print(f"\n‚ö†Ô∏è  Erreur: {error_msg}")
            
            # Essayer de deviner le module manquant
            if "'Fore'" in error_msg or "'Style'" in error_msg:
                print("   Solution: pip install colorama")
                install_missing_packages()
                # R√©essayer avec colorama
                try:
                    import colorama
                    from colorama import Fore, Style
                    colorama.init(autoreset=True)
                    globals['Fore'] = Fore
                    globals['Style'] = Style
                    return original_exec(code, globals, locals)
                except:
                    pass
            
            elif "'requests'" in error_msg:
                print("   Solution: pip install requests")
                install_missing_packages()
            
            elif "'Client'" in error_msg or "'TelegramClient'" in error_msg:
                print("   Solution: pip install telethon")
                install_missing_packages()
            
            raise
    
    # Remplacer exec
    builtins.exec = patched_exec
    
    return code_obj

def run_decrypted_code():
    """Ex√©cute le code d√©chiffr√©"""
    
    # Installer d√©pendances
    install_missing_packages()
    
    # Pr√©parer l'ex√©cution
    code_obj = patch_code_execution()
    if not code_obj:
        return
    
    print("\n" + "="*50)
    print("üöÄ EX√âCUTION DU CODE")
    print("="*50)
    
    try:
        # Cr√©er un bon environnement global
        import_dict = {}
        
        # Importer les modules courants
        try:
            import colorama
            from colorama import Fore, Style, init
            init(autoreset=True)
            import_dict['Fore'] = Fore
            import_dict['Style'] = Style
            import_dict['colorama'] = colorama
            print("‚úÖ colorama import√©")
        except ImportError:
            # Cr√©er des faux Fore, Style si colorama pas disponible
            class FakeFore:
                RED = '\033[91m'
                GREEN = '\033[92m'
                YELLOW = '\033[93m'
                BLUE = '\033[94m'
                MAGENTA = '\033[95m'
                CYAN = '\033[96m'
                WHITE = '\033[97m'
                RESET = '\033[0m'
            
            class FakeStyle:
                RESET_ALL = '\033[0m'
            
            import_dict['Fore'] = FakeFore
            import_dict['Style'] = FakeStyle
            print("‚ö†Ô∏è  colorama non trouv√©, utilisation couleurs basiques")
        
        try:
            import requests
            import_dict['requests'] = requests
            print("‚úÖ requests import√©")
        except ImportError:
            print("‚ö†Ô∏è  requests non install√©")
        
        try:
            import asyncio
            import_dict['asyncio'] = asyncio
            print("‚úÖ asyncio import√©")
        except ImportError:
            print("‚ö†Ô∏è  asyncio non disponible")
        
        try:
            import os
            import sys
            import time
            import json
            import re
            import_dict['os'] = os
            import_dict['sys'] = sys
            import_dict['time'] = time
            import_dict['json'] = json
            import_dict['re'] = re
        except:
            pass
        
        # Ex√©cuter le code
        exec(code_obj, import_dict)
        
    except Exception as e:
        print(f"\n‚ùå Erreur d'ex√©cution: {e}")
        
        # Analyse de l'erreur
        if "NameError" in str(type(e)):
            print("\nüîç ANALYSE DE L'ERREUR:")
            error_msg = str(e)
            
            if "Fore" in error_msg:
                print("   ‚Ä¢ Manque: colorama.Fore")
                print("   ‚Ä¢ Solution: pip install colorama")
            
            if "requests" in error_msg:
                print("   ‚Ä¢ Manque: requests")
                print("   ‚Ä¢ Solution: pip install requests")
            
            if "TelegramClient" in error_msg or "telethon" in error_msg:
                print("   ‚Ä¢ Manque: telethon")
                print("   ‚Ä¢ Solution: pip install telethon")
        
        import traceback
        traceback.print_exc()
        
        # Demander installation
        print("\nüì¶ Installer les d√©pendances manquantes? (o/n)")
        if input().strip().lower() == 'o':
            install_missing_packages()
            print("\nüîÑ R√©essayer l'ex√©cution? (o/n)")
            if input().strip().lower() == 'o':
                run_decrypted_code()

def main():
    """Fonction principale"""
    
    print("üéÆ EX√âCUTEUR DE CODE D√âCHIFFR√â")
    print("=" * 50)
    
    # V√©rifier fichiers
    if not all(os.path.exists(f) for f in ['code_object.bin', 'task.py']):
        print("‚ùå Fichiers manquants")
        print("   Ex√©cutez d'abord: python real_decrypt.py")
        return
    
    # Ex√©cuter
    run_decrypted_code()

if __name__ == "__main__":
    import os
    main()
